![](/nixos-and-flakes-book.webp)

# Nix と NixOS の紹介

Nix は宣言的パッケージ管理システムです。ユーザーが宣言的設定を設定ファイルに記載し「あるべき環境の状態」を表現するだけで、Nix がその状態の実現を担ってくれます。

> 「宣言的設定」とは、ユーザーが望む状態をただ宣言するだけでよい、ということです。例えば、「 i3 デスクトップを sway に置き換えたい」と宣言するだけで、Nix がその目標を達成してくれます。ユーザーは、sway のインストールに必要なパッケージは何か、どの i3 関連パッケージを削除すべきか、あるいは NVIDIA のグラフィックカードを使っている場合に sway を正常に動作させるためにどのような調整が必要か、といった細部を気にする必要がありません。Nix がこれらすべてを自動的に処理します（もちろん、これは sway と i3 の Nix パッケージが適切に作られていることが前提です）。

この Nix パッケージ管理システムを基盤として構築された Linux ディストリビューションが NixOS です。NixOS は、まさに OS as Code（コードとしてのOS）と表現でき、宣言的な Nix 設定ファイルを用いてオペレーティングシステム全体の構成を管理します。

OS は無数のパッケージや設定ファイル、データで構成されていますが、宣言的設定で管理できるのはその中の静的な部分に限られます。PostgreSQL やMySQL のようなデータベース内の動的なデータは、この方法では管理できません（デプロイのたびに、設定に記述されていないデータをすべて削除するわけにはいきませんから）。そのため、NixOS が管理するのも、実際にはシステム構成の一部です。データベースのデータや、ユーザーのホームディレクトリ内のファイルは管理対象外であり、システムを以前のバージョンにロールバックしても、これらのデータには一切変更が加えられません。

しかし、ユーザーのホームディレクトリには、[Dotfiles](https://wiki.archlinux.org/title/Dotfiles) と呼ばれる重要な設定ファイルが数多く存在します。これらも Nix で管理したいと考えるのは自然なことです。そのニーズに応えるのが、コミュニティの重要なプロジェクトである [home-manager](https://github.com/nix-community/home-manager) です。これは、ユーザーのホームディレクトリ内の設定ファイルや、ユーザー単位でインストールするパッケージを管理するために設計されています。

Nix の宣言的で再現可能であるという特性は、デスクトップ環境の管理に留まらず、開発環境、CI/CD、仮想マシンやコンテナイメージの構築など、多岐にわたる分野で活用されています。公式の [NixOps](https://github.com/NixOS/nixops) やコミュニティ製の [colmena](https://github.com/zhaofengli/colmena) は、Nix を活用した運用管理ツールです。

## なぜ NixOS なのか？

数年前に Nix というパッケージ管理システムの存在を知りました。曰く、Nix 言語でシステムの構成を記述し、NixOS という Linux ディストリビューションを使えば、システムを過去のどの状態にもロールバックできるらしい（実際には、Nix 言語で設定ファイルに記述した部分しかロールバックできません）、と。当時は非常に魅力的に聞こえましたが、新しい言語を学び、パッケージをインストールするためだけにコードを書くのは面倒だと感じ、深くは追求しませんでした。

しかし最近、私が使っていた EndeavourOS でトラブルが頻発し、その解決に多くの時間を費やして心身ともに疲れ果ててしまいました。突き詰めて考えれば、これらの問題の根本原因はシステムのバージョン管理やロールバック機能がないことでした。一度問題が起きると元に戻せず、ひたすら情報を探してバグを特定し、手作業でシステムを修復するしかありませんでした。

そこで私は NixOS への移行を決意しました。

NixOS に切り替えてからの満足度は、言葉では言い表せないほどです。何より驚いたのは、まっさらな NixOS マシンで、たった一行のコマンド（`sudo nixos-rebuild switch --flake .`）を実行するだけで私が使っていた i3 デスクトップ環境とすべてのアプリケーションが完全に復元されたことです。

NixOS のロールバック機能と再現性は、私に大きな安心感を与えてくれました。もうシステムが壊れることを恐れる必要はありません（壊れたらロールバックすればいいだけです）。そのおかげで、以前は躊躇していた Hyprland や Waybar といった新しい技術も、気軽に試せるようになりました。EndeavourOS を使っていた頃は、システムに不具合が生じた際の手間を考えると、とてもそんな気にはなれませんでした。

NixOS と Nix への理解が深まるにつれ、これが複数マシンの設定を同期させるのにも非常に適していることに気づきました。現在、私の個人設定リポジトリ[ryan4yin/nix-config](https://github.com/ryan4yin/nix-config)では、以下の多様なマシンの設定をまとめて管理しています。

- デスクトップマシン
  - Macbook Pro 2022 (M2, aarch64)
  - Macbook Pro 2024 (M4Pro, aarch64)
  - 自作 NixOS デスクトップ PC (amd64)
- サーバー
  - 10台以上の NixOS 仮想マシン (amd64)
  - aarch64 および riscv64 の開発ボード数枚

これら3台のデスクトップマシンの開発環境は Home Manager で管理されており、主要な設定はすべて共通化されています。いずれか1台で設定を変更すれば、Git を通じて他のマシンにもシームレスに反映されます。NixOS は、OS やチップアーキテクチャの違いをほとんど意識することなく使うことができます。その体験は、まさに「スムーズ」の一言です。
