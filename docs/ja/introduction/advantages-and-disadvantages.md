# NixOS のメリットとデメリット

## メリット

- **宣言的な設定（OS as Code）**
  - NixOS では宣言的な設定によってシステム環境全体が管理されます。これらの設定は直接 Git で管理でき、設定ファイルがなくならない限りシステムはいつでも任意の履歴状態に復元できます（ただし、Nix 設定ファイルで宣言された状態のみが復元可能です）。
  - Nix Flakes は `flake.lock` をバージョンロックファイルとして使用し、すべての依存関係のデータソースアドレスとハッシュ値、その他関連情報を記録します。これにより、Nix の再現性を大幅に向上させ、ビルド結果の一貫性を保証します。これは Cargo や npm などのプログラミング言語のパッケージ管理設計から着想を得たものです。
- **非常に便利なシステムカスタマイズ機能**
  - 設定を数行変更するだけで、システムのさまざまなコンポーネントを簡単に交換できます。Nix が本来必要だった複雑な操作をすべて Nix パッケージにカプセル化し、ユーザーに簡潔な宣言的パラメータを提供しています。
  - この種の変更は非常に安全で、落とし穴に嵌ることなくさまざまなデスクトップ環境（gnome, KDE, i3, sway など）を簡単に行き来できます。
- **ロールバック機能**
  - いつでも任意の履歴環境にロールバックできます。NixOS はデフォルトですべての古いバージョンをブートオプションに含んでいるため、変更を簡単に戻すことができます。そのため、Nix は最も安定したパッケージ管理手法といえます。
- **依存関係の競合問題がない**
  - Nix の各ソフトウェア・パッケージは固有のハッシュ値を持ち、それがインストールパスに組み込まれるため、複数のバージョンを共存させることができます。
- **コミュニティが活発で、サードパーティプロジェクトも豊富**
  - 公式パッケージリポジトリ nixpkgs には数多くの貢献者がおり、多くの人が自分の Nix の設定を共有しています。NixOSのエコシステムを探索するのは、まるで新大陸を発見するかのようなワクワクする体験です。

<figure>
  <img src="/nixos-bootloader.avif">
  <figcaption>
    <h4 align="center">
      すべての履歴バージョンがブートオプションとしてリストアップされている様子
      <a href="https://discourse.nixos.org/t/how-to-make-uefis-grub2-menu-the-same-as-bioss-one/10074" target="_blank" rel="noopener noreferrer">
        NixOS Discourse - 10074
      </a>
      より
    </h4>
  </figcaption>
</figure>

## デメリット {#disadvantages}

- **学習コストが高い**:
  - システムを完璧に再現可能にしたり、間違った使い方をして落とし穴に嵌まるのを避けたりするには、`nix-env -i`（`apt-get install` みたいなもの）のようなコマンドをやみくもに使うのではなく、Nix の設計全体を学び、宣言的にシステムを管理する必要があります。
- **ドキュメントが混乱している**:
  - 現時点では Nix Flakes は実験的な機能であり、それに特化したドキュメントが不足しています。Nixコミュニティの多くのドキュメントは、主に従来の `/etc/nixos/configuration.nix` について取り扱っています。もし直接 Nix Flakes（`flake.nix`）から学び始めるには、古いドキュメントを大量に参照し、その中から必要な情報を抜き出す必要があります。さらに、Nix のコア機能である `imports` や Nixpkgs モジュールシステムについては公式の詳細なドキュメントがなく、ソースコードを直接読み解かなければならないこともあります。
- **ディスク容量を比較的多く消費する**:
  - システムをいつでもロールバックできるよう Nix はデフォルトで常にすべての履歴環境を保持しており、結果として多くのディスク容量を消費することになります。
  - より多くの容量を消費することはデスクトップコンピュータでは問題ないかもしれませんが、リソースが制限されたクラウドサーバーでは問題になる可能性があります。
- **エラーメッセージが分かりづらい**:
  - [Nixpkgs のモジュールシステム](../other-usage-of-flakes/module-system.md) の [複雑なマージアルゴリズム](https://discourse.nixos.org/t/best-resources-for-learning-about-the-nixos-module-system/1177/4) のせいで、NixOS のエラーメッセージは非常に貧弱です。多くの場合、`--show-trace` を追加するかどうかに関係なく、コードにエラーがあることしか教えてくれません（最もありふれていて紛らわしいエラーメッセージは [Infinite recursion encountered](https://discourse.nixos.org/t/infinite-recursion-encountered-by-making-module-configurable/23508/2) です）。しかし、具体的にどこが間違っているのでしょうか？型システムがわからないと言っている以上、自分で見つけるしかありません。私の経験上、**このような意味のないエラーメッセージに遭遇した場合、最も簡単で効果的な解決策は、「二分探索」を用いてコードを少しずつ元に戻すことです**。
  - この問題が現時点での NixOS の最大の問題点かもしれません。
- **基盤となる実装がより複雑**：
  - Nix が宣言的な抽象化を行ったことで、基盤となるコードの複雑さが従来の手続的なツールにおける同種のコードより増大しています。
  - この複雑さが実装の難易度を上げ、低レベルにおける独自の修正を難しくしています。しかし、この負担は主に Nix パッケージのメンテナにかかるものであり、一般ユーザーがこの複雑さに触れる機会は限られているため負担は少ないです。

## 簡単なまとめ {#summary}

全体として、NixOS はある程度の Linux 使用経験とプログラミング経験があり、自分のシステムをより強くコントロールしたいと考えている開発者に適していると思います。

Linux の利用経験がまったくない初心者がいきなり NixOS に挑戦するのは険しい道のりになる可能性が高く、おすすめしません。

> NixOS についてさらに質問がある場合は、本書の最終章「[よくある質問](../faq/)」をご覧ください。
